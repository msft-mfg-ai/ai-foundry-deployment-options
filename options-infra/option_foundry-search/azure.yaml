# deploying using AZD because https://github.com/Azure/azure-cli/pull/31990
name: deploy-foundry-search

infra:
  provider: bicep
  path: .
  module: main

hooks:
  postup:
    windows:
      shell: pwsh
      run: |
        Write-Host "=========================================="
        Write-Host "Deployment complete! Setting up search indexes..."
        Write-Host "=========================================="
        
        # Install dependencies
        Write-Host "Installing Python dependencies with uv..."
        Push-Location scripts
        uv sync
        
        # Create indexes for each search service
        Write-Host ""
        Write-Host "Creating index on AI_SEARCH_SERVICE_PUBLIC_NO_PE..."
        uv run python create_index.py "$env:AI_SEARCH_SERVICE_PUBLIC_NO_PE" --index "good-books-azd"
        
        Write-Host ""
        Write-Host "Creating index on AI_SEARCH_SERVICE_PUBLIC_PE..."
        uv run python create_index.py "$env:AI_SEARCH_SERVICE_PUBLIC_PE" --index "good-books-azd"
        
        # For AI_SEARCH_PE: Open firewall, wait, run script, close firewall
        Write-Host ""
        Write-Host "Opening firewall for AI_SEARCH_PE..."
        az search service update --name $env:AI_SEARCH_PE_NAME --resource-group $env:AZURE_RESOURCE_GROUP --location $env:AZURE_LOCATION --public-access enabled --output none
        
        Write-Host "Waiting for API to become accessible..."
        $maxRetries = 30
        $retryCount = 0
        do {
            Start-Sleep -Seconds 5
            $retryCount++
            try {
                $response = Invoke-WebRequest -Uri "$env:AI_SEARCH_PE/indexes?api-version=2024-07-01" -Method Get -UseBasicParsing -ErrorAction Stop
                $apiReady = $true
            } catch {
                Write-Host "  Attempt $retryCount/$maxRetries - API not ready yet..."
                $apiReady = $false
            }
        } while (-not $apiReady -and $retryCount -lt $maxRetries)
        
        if ($apiReady) {
            Write-Host "API is ready! Creating index..."
            uv run python create_index.py "$env:AI_SEARCH_PE" --index "good-books-azd"
        } else {
            Write-Host "Warning: API did not become ready in time, skipping index creation"
        }
        
        Write-Host "Closing firewall for AI_SEARCH_PE..."
        az search service update --name $env:AI_SEARCH_PE_NAME --resource-group $env:AZURE_RESOURCE_GROUP --location $env:AZURE_LOCATION --public-access disabled --output none
        
        Pop-Location
        
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "All search indexes created successfully!"
        Write-Host "=========================================="
      interactive: true
      continueOnError: false
    posix:
      shell: sh
      run: |
        echo "=========================================="
        echo "Deployment complete! Setting up search indexes..."
        echo "=========================================="
        
        # Install dependencies
        echo "Installing Python dependencies with uv..."
        cd scripts
        uv sync
        
        # Create indexes for each search service
        echo ""
        echo "Creating index on AI_SEARCH_SERVICE_PUBLIC_NO_PE..."
        uv run python create_index.py "${AI_SEARCH_SERVICE_PUBLIC_NO_PE}" --index "good-books-azd"
        
        echo ""
        echo "Creating index on AI_SEARCH_SERVICE_PUBLIC_PE..."
        uv run python create_index.py "${AI_SEARCH_SERVICE_PUBLIC_PE}" --index "good-books-azd"
        
        # For AI_SEARCH_PE: Open firewall, wait, run script, close firewall
        echo ""
        echo "Opening firewall for AI_SEARCH_PE..."
        az search service update --name "${AI_SEARCH_PE_NAME}" --resource-group "${AZURE_RESOURCE_GROUP}" --public-access enabled --output none
        
        echo "Waiting for API to become accessible..."
        MAX_RETRIES=30
        RETRY_COUNT=0
        API_READY=false
        
        while [ "$API_READY" = "false" ] && [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            sleep 5
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if curl -s -o /dev/null -w "%{http_code}" "${AI_SEARCH_PE}/indexes?api-version=2024-07-01" | grep -q "401\|200"; then
                API_READY=true
                echo "API is ready!"
            else
                echo "  Attempt ${RETRY_COUNT}/${MAX_RETRIES} - API not ready yet..."
            fi
        done
        
        if [ "$API_READY" = "true" ]; then
            echo "Creating index..."
            uv run python create_index.py "${AI_SEARCH_PE}" --index "good-books-azd"
        else
            echo "Warning: API did not become ready in time, skipping index creation"
        fi
        
        echo "Closing firewall for AI_SEARCH_PE..."
        az search service update --name "${AI_SEARCH_PE_NAME}" --resource-group "${AZURE_RESOURCE_GROUP}" --public-access disabled --output none --no-wait
        
        cd ..
        
        echo ""
        echo "=========================================="
        echo "All search indexes created successfully!"
        echo "=========================================="
      interactive: true
      continueOnError: false